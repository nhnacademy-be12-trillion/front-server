<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <title>Trillion-Shop | 관리자 페이지</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="관리자, 주문, 정책, 회원" name="keywords">
  <meta content="Trillion-Shop 관리자 시스템" name="description">

  <link th:href="@{/img/favicon.ico}" rel="icon">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <link th:href="@{/lib/animate/animate.min.css}" rel="stylesheet">
  <link th:href="@{/lib/owlcarousel/assets/owl.carousel.min.css}" rel="stylesheet">
  <link href="/css/style.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f5f5f5;
    }

    .admin-container {
      padding-top: 50px;
      padding-bottom: 50px;
    }

    .nav-pills .nav-link {
      border-radius: 0.25rem;
      margin-bottom: 5px;
      background-color: #e9ecef;
      color: #3D464D;
    }

    .nav-pills .nav-link.active,
    .nav-pills .nav-link:hover {
      background-color: #5BADE9;
      color: #fff;
    }

    .policy-group {
      border: 1px solid #dee2e6;
      padding: 20px;
      margin-bottom: 30px;
      background-color: #fff;
    }
  </style>
</head>

<body>
<div class="container-fluid admin-container">
  <h1 class="text-dark mb-4 text-center">Trillion-Shop 관리 시스템</h1>

  <div class="row px-xl-5">
    <!-- 좌측 메뉴 -->
    <div class="col-lg-3 col-md-4">
      <h5 class="section-title position-relative text-uppercase mb-4">
        <span class="bg-secondary pr-3">관리 메뉴</span>
      </h5>
      <div class="nav flex-column nav-pills" id="admin-tab" role="tablist" aria-orientation="vertical">
        <a class="nav-link active" id="orders-tab" data-toggle="pill" href="#orders-content" role="tab">
          최근 주문 관리 (200건)
        </a>
        <a class="nav-link" id="policy-tab" data-toggle="pill" href="#policy-content" role="tab">
          정책 설정
        </a>
        <a class="nav-link" id="member-tab" data-toggle="pill" href="#member-content" role="tab">
          회원 관리
        </a>
      </div>
    </div>

    <!-- 우측 콘텐츠 -->
    <div class="col-lg-9 col-md-8">
      <div class="tab-content" id="admin-tabContent">

        <!-- 최근 주문 관리 탭 -->
        <div class="tab-pane fade show active" id="orders-content" role="tabpanel">
          <h4 class="mb-4 text-primary">최근 주문 조회</h4>

          <!-- 주문 검색 영역 -->
          <form th:action="@{/api/admin/orders}" method="get" class="mb-3">
            <div class="form-row">
              <div class="col-md-4 mb-2">
                <input type="text" name="keyword" class="form-control"
                       placeholder="주문번호 / 회원ID / 수령인">
              </div>
              <div class="col-md-3 mb-2">
                <input type="date" name="fromDate" class="form-control" placeholder="시작일">
              </div>
              <div class="col-md-3 mb-2">
                <input type="date" name="toDate" class="form-control" placeholder="종료일">
              </div>
              <div class="col-md-2 mb-2">
                <button type="submit" class="btn btn-primary btn-block">
                  <i class="fa fa-search mr-1"></i> 주문 검색
                </button>
              </div>
            </div>
            <small class="text-muted">
              주문번호는 <strong>ORD-3a6e29ec-...</strong> 형태 전체를 입력해도 되고, 일부만 입력해도 검색 가능하게 구현하면 좋아요.
            </small>
          </form>

          <!-- 최근 주문 테이블 -->
          <div class="table-responsive">
            <table class="table table-light table-hover text-center mb-0">
              <thead class="thead-dark">
              <tr>
                <th style="width:20%;">주문번호</th>
                <th>주문자 ID</th>
                <th>총액</th>
                <th>주문일</th>
                <th>상태</th>
                <th style="width: 200px;">관리</th>
              </tr>
              </thead>
              <tbody>
              <!-- 주문 목록 있을 때 -->
              <tr th:each="order : ${orders}">
                <!-- 주문번호: 너무 긴 문자열은 한 줄로 잘라서 표시, 전체 값은 title 로 제공 -->
                <td class="align-middle text-left">
                  <a th:href="@{/api/admin/orders/{orderId}(orderId=${order.id})}"
                     class="text-primary font-weight-bold d-inline-block text-truncate"
                     style="max-width: 180px;"
                     th:text="${order.orderNumber}"
                     th:title="${order.orderNumber}">
                    ORD-3a6e29ec-f84c-491d-a13e-8aeeb90ffa58
                  </a>
                </td>
                <td class="align-middle" th:text="${order.memberId}">user123</td>
                <td class="align-middle"
                    th:text="${#numbers.formatInteger(order.totalAmount, 0, 'COMMA')} + '원'">
                  25,000원
                </td>
                <td class="align-middle"
                    th:text="${#temporals.format(order.orderedAt, 'yyyy-MM-dd HH:mm')}">
                  2025-12-01 13:45
                </td>
                <td class="align-middle" th:text="${order.status}">
                  결제 완료
                </td>
                <td class="align-middle">
                  <a th:href="@{/api/admin/orders/{orderId}(orderId=${order.id})}"
                     class="btn btn-sm btn-outline-primary mb-1">
                    상세 보기
                  </a>
                  <button type="button"
                          class="btn btn-sm btn-danger mb-1"
                          th:data-order-id="${order.id}">
                    결제 취소
                  </button>
                  <button type="button"
                          class="btn btn-sm btn-warning mb-1"
                          th:data-order-id="${order.id}">
                    반품 처리
                  </button>
                </td>
              </tr>

              <!-- 주문 없을 때 -->
              <tr th:if="${orders == null or #lists.isEmpty(orders)}">
                <td colspan="6" class="py-4 text-muted">
                  조회된 주문 내역이 없습니다. 검색 조건을 변경해 보세요.
                </td>
              </tr>
              </tbody>
            </table>
          </div>

          <!-- 페이징 (예시) -->
          <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
              <li class="page-item disabled">
                <a class="page-link" href="#" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              <li class="page-item active"><a class="page-link" href="#">1</a></li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item">
                <a class="page-link" href="#" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>

        <!-- 정책 설정 탭 -->
        <div class="tab-pane fade" id="policy-content" role="tabpanel">
          <h4 class="mb-4 text-primary">정책 설정 및 관리</h4>

          <!-- 🚛 배송 정책 : 이 폼만 따로 전송 -->
          <div class="policy-group">
            <h5 class="mb-3">🚛 배송 정책 설정</h5>
            <form th:action="@{/api/admin/policies/shipping}" method="post">
              <div class="form-group row">
                <label class="col-sm-4 col-form-label">기본 배송비 (원)</label>
                <div class="col-sm-8">
                  <input type="number" class="form-control"
                         name="shippingFee"
                         th:value="${shippingPolicy.shippingFee}"
                         min="0" required>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-4 col-form-label">배송비 무료 조건 금액 (원)</label>
                <div class="col-sm-8">
                  <input type="number" class="form-control"
                         name="freeShippingCondition"
                         th:value="${shippingPolicy.freeShippingCondition}"
                         min="0" required>
                </div>
              </div>
              <div class="text-right">
                <button type="submit" class="btn btn-sm btn-primary">
                  배송 정책 저장
                </button>
              </div>
            </form>
          </div>

          <!-- 🎁 포장 정책 : 기존 정책 수정 / 새 정책 추가를 각각 별도 폼으로 -->
          <div class="policy-group">
            <h5 class="mb-3">🎁 포장 정책 설정</h5>
            <p class="text-muted small mb-4">
              기존 포장지 정책은 드롭다운에서 선택 후 가격만 수정할 수 있고,
              새로운 포장지 정책은 이름과 가격을 입력해 추가할 수 있습니다.
            </p>

            <!-- 기존 포장지 가격 수정 -->
            <form th:action="@{/api/admin/policies/packaging/update}" method="post" class="mb-4">
              <h6 class="mt-2 mb-3 text-secondary">▪️ 기존 포장지 가격 수정</h6>
              <div class="form-group row">
                <label class="col-sm-4 col-form-label">기존 포장지 선택</label>
                <div class="col-sm-8">
                  <select class="custom-select" name="packagingName" id="packagingSelect" required>
                    <option value="" selected disabled>포장지를 선택하세요</option>
                    <option th:each="pkg : ${packagingList}"
                            th:value="${pkg.name}"
                            th:data-price="${pkg.price}"
                            th:text="${pkg.name + ' (' + #numbers.formatInteger(pkg.price,0,'COMMA') + '원)'}">
                      일반 포장지 (0원)
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-4 col-form-label">선택 포장지 가격 (원)</label>
                <div class="col-sm-8">
                  <input type="number" class="form-control"
                         name="price" id="packagingPrice"
                         placeholder="선택한 포장지의 가격을 입력하세요"
                         min="0" required>
                </div>
              </div>
              <div class="text-right">
                <button type="submit" class="btn btn-sm btn-primary">
                  선택 포장지 가격 수정
                </button>
              </div>
            </form>

            <!-- 새로운 포장지 정책 추가 -->
            <form th:action="@{/api/admin/policies/packaging/new}" method="post">
              <h6 class="mt-4 mb-3 text-secondary">▪️ 새로운 포장지 정책 추가</h6>
              <div class="form-group row">
                <label class="col-sm-4 col-form-label">포장지 이름</label>
                <div class="col-sm-8">
                  <input type="text" class="form-control"
                         name="name"
                         placeholder="새 포장지 이름 (예: 크리스마스 에디션)" required>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-4 col-form-label">가격 (원)</label>
                <div class="col-sm-8">
                  <input type="number" class="form-control"
                         name="price"
                         placeholder="가격 (숫자만)" min="0" required>
                </div>
              </div>
              <div class="text-right">
                <button type="submit" class="btn btn-sm btn-info">
                  새 포장지 정책 추가
                </button>
              </div>
            </form>
          </div>

          <!-- 💰 포인트 적립 정책 -->
          <div class="policy-group">
            <h5 class="mb-3">💰 포인트 적립률 설정</h5>

            <!-- 기본 적립률 단독 저장 -->
            <form th:action="@{/api/admin/policies/points/base}" method="post" class="mb-4">
              <div class="form-group row">
                <label class="col-sm-4 col-form-label">기본 적립률 (% / 도서 판매액 대비)</label>
                <div class="col-sm-8">
                  <input type="number" class="form-control"
                         name="basePointRate"
                         th:value="${pointPolicy.basePointRate}"
                         step="0.1" min="0" required>
                </div>
              </div>
              <div class="text-right">
                <button type="submit" class="btn btn-sm btn-primary">
                  기본 적립률 저장
                </button>
              </div>
            </form>

            <!-- 회원 등급별 추가 적립률 : 한 번에 모든 등급을 저장 -->
            <form th:action="@{/api/admin/policies/points/grades}" method="post">
              <h6 class="mt-2 mb-3">회원 등급별 추가 적립률 (%)</h6>
              <p class="text-muted small">
                각 등급에 대해 추가로 적립할 비율을 입력하고, 아래 버튼으로 한 번에 저장됩니다.
              </p>

              <div class="form-group row" th:each="grade, stat : ${memberGrades}">
                <label class="col-sm-4 col-form-label"
                       th:text="${grade.displayName} + ' 등급'">
                  COMMON 등급
                </label>
                <div class="col-sm-8 input-group">
                  <!-- 등급 ID/Level 을 숨겨서 같이 보냄 -->
                  <input type="hidden"
                         th:name="'gradeRates[' + ${stat.index} + '].level'"
                         th:value="${grade.level}">
                  <div class="input-group-prepend">
                    <span class="input-group-text" th:text="${grade.level}">
                      COMMON
                    </span>
                  </div>
                  <input type="number"
                         class="form-control"
                         th:name="'gradeRates[' + ${stat.index} + '].rate'"
                         th:value="${grade.rate}"
                         step="0.1" min="0" required>
                  <div class="input-group-append">
                    <span class="input-group-text">%</span>
                  </div>
                </div>
              </div>

              <div class="text-right mt-3">
                <button type="submit" class="btn btn-sm btn-primary">
                  등급별 추가 적립률 일괄 저장
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- 회원 관리 탭 -->
        <div class="tab-pane fade" id="member-content" role="tabpanel">
          <h4 class="mb-4 text-primary">회원 아이디 조회 및 휴면 해제</h4>

          <form th:action="@{/api/admin/members/search}" method="get" class="mb-4">
            <div class="input-group">
              <input type="text" name="memberId" class="form-control p-4"
                     placeholder="검색할 회원 아이디를 입력하세요 (예: user123)" required>
              <div class="input-group-append">
                <button type="submit" class="btn btn-primary px-4">
                  <i class="fa fa-search"></i> 회원 조회
                </button>
              </div>
            </div>
          </form>

          <div class="table-responsive">
            <table class="table table-light table-hover text-center mb-0">
              <thead class="thead-dark">
              <tr>
                <th>회원번호</th>
                <th>아이디</th>
                <th>이름</th>
                <th>상태</th>
                <th>관리</th>
              </tr>
              </thead>
              <tbody>
              <tr th:if="${memberInfo != null}">
                <td th:text="${memberInfo.id}">M1234</td>
                <td th:text="${memberInfo.userId}">dormant_user</td>
                <td th:text="${memberInfo.name}">홍길동</td>
                <td th:classappend="${memberInfo.isDormant} ? 'text-danger' : 'text-success'"
                    th:text="${memberInfo.isDormant} ? '휴면 상태' : '정상'">
                  휴면 상태
                </td>
                <td>
                  <button th:if="${memberInfo.isDormant}"
                          class="btn btn-sm btn-success"
                          th:data-member-id="${memberInfo.id}">
                    휴면 해제 요청
                  </button>
                  <span th:unless="${memberInfo.isDormant}" class="text-muted">
                    관리 불필요
                  </span>
                </td>
              </tr>
              <tr th:unless="${memberInfo != null}">
                <td colspan="5" class="py-4 text-muted">
                  검색 결과가 없거나, 아직 회원을 조회하지 않았습니다.
                </td>
              </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/lib/easing/easing.min.js}"></script>
<script th:src="@{/lib/owlcarousel/owl.carousel.min.js}"></script>
<script th:src="@{/js/main.js}"></script>

<script th:inline="javascript">
  $(function () {
    // 포장지 셀렉트박스 선택 시, 해당 가격을 입력 필드에 세팅
    $('#packagingSelect').on('change', function () {
      var price = $(this).find(':selected').data('price');
      if (price !== undefined) {
        $('#packagingPrice').val(price);
      } else {
        $('#packagingPrice').val('');
      }
    });
  });
</script>
</body>
</html>
