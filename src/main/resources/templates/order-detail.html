<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">

<head>
    <meta charset="utf-8">
    <title>Trillion-Shop | 주문 상세 정보</title>

    <th:block layout:fragment="head">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta content="주문, 상세, 내역" name="keywords">
        <meta content="온라인 도서 판매 사이트 주문 상세 정보" name="description">

        <style>
            .table-secondary {
                background-color: #f4f4f4;
            }
        </style>
    </th:block>
</head>

<body>

<div layout:fragment="content">

    <!-- Breadcrumb -->
    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-12">
                <nav class="breadcrumb bg-light mb-30">
                    <a class="breadcrumb-item text-dark" th:href="@{/}">홈</a>
                    <a class="breadcrumb-item text-dark" th:if="${isMember}" th:href="@{/api/members/my-page}">마이페이지</a>
                    <a class="breadcrumb-item text-dark" th:if="${!isMember}" th:href="@{/orders/non-members-form}">비회원 주문 조회</a>
                    <span class="breadcrumb-item active">주문 상세 정보</span>
                </nav>
            </div>
        </div>
    </div>

    <div class="container-fluid pb-5">
        <div class="row px-xl-5">

            <!-- Left: Items + Payment -->
            <div class="col-lg-8">

                <!-- 주문상품 목록 -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="m-0">주문 상품 목록</h5>
                    </div>

                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered text-center mb-0">
                                <thead class="bg-secondary text-dark">
                                <tr>
                                    <th>상품 정보</th>
                                    <th style="width: 15%;">단가</th>
                                    <th style="width: 10%;">수량</th>
                                    <th style="width: 15%;">포장비</th>
                                    <th style="width: 15%;">합계</th>
                                    <th style="width: 15%;" th:text="${isMember} ? '관리' : '상태'">관리</th>
                                </tr>
                                </thead>

                                <tbody class="align-middle">
                                <tr th:each="item : ${order.orderItems}"
                                    th:classappend="${#lists.contains({'CANCELED','RETURNED'}, item.orderItemStatus.name())} ? 'table-secondary' : ''">

                                    <!-- 상품 정보 -->
                                    <td class="align-middle text-left">
                                        <div class="d-flex align-items-center">
                                            <img th:src="${item.thumbnailUrl != null ? item.thumbnailUrl : '/img/product-1.jpg'}"
                                                 alt="Book"
                                                 style="width: 50px; aspect-ratio: 1/1.4; object-fit: cover; margin-right: 15px;">
                                            <span th:text="${item.bookName}">책 제목</span>
                                        </div>
                                    </td>

                                    <!-- 단가 -->
                                    <td th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + '원'"></td>

                                    <!-- 수량 -->
                                    <td th:text="${item.quantity}"></td>

                                    <!-- 포장비 -->
                                    <td th:text="${item.packagingPrice > 0 ?
                                                  #numbers.formatDecimal(item.packagingPrice, 0, 'COMMA', 0, 'POINT') + '원'
                                                  : '-'}"></td>

                                    <!-- 합계 -->
                                    <td th:text="${#numbers.formatDecimal((item.price * item.quantity) + item.packagingPrice,
                                                0, 'COMMA', 0, 'POINT') + '원'}"></td>

                                    <!-- 상태별 버튼 (회원) -->
                                    <td th:if="${isMember}" th:switch="${item.orderItemStatus.name()}">
                                        <!-- 상품 준비중 -->
                                        <span th:case="'PREPARING'" class="font-weight-bold">상품 준비중</span>

                                        <!-- 배송 중 -->
                                        <div th:case="'SHIPPED'">
                                            <span class="d-block font-weight-bold mb-2">배송중</span>
                                            <button class="btn btn-sm btn-info w-100">배송 조회</button>
                                        </div>

                                        <!-- 배송 완료 -->
                                        <div th:case="'DELIVERED'">
                                            <form th:action="@{/orders/{orderId}/items/{itemId}/confirm(orderId=${order.orderId}, itemId=${item.orderItemId})}"
                                                  method="post" class="mb-1">
                                                <button type="submit" class="btn btn-sm btn-primary w-100">구매 확정</button>
                                            </form>
                                            <form th:action="@{/orders/{orderId}/items/{itemId}/return(orderId=${order.orderId}, itemId=${item.orderItemId})}" method="post" class="return-form">
                                                <input type="hidden" name="reason" value="">
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                        반품하기
                                                    </button>
                                                    <div class="dropdown-menu">
                                                        <a class="dropdown-item return-reason-select" href="#" data-reason="CHANGE_OF_MIND">단순 변심</a>
                                                        <a class="dropdown-item return-reason-select" href="#" data-reason="DAMAGED">상품 파손</a>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- 구매 확정 -->
                                        <div th:case="'CONFIRMED'">
                                            <span class="d-block font-weight-bold mb-2">구매 확정</span>
                                            <button class="btn btn-sm btn-success w-100">리뷰 작성</button>
                                        </div>

                                        <!-- 반품 요청 (단순 변심) -->
                                        <span th:case="'RETURN_REQUESTED_CHANGE_OF_MIND'" class="text-muted">반품 요청 (단순 변심)</span>

                                        <!-- 반품 요청 (파손) -->
                                        <span th:case="'RETURN_REQUESTED_DAMAGED'" class="text-muted">반품 요청 (파손)</span>

                                        <!-- 반품 완료 -->
                                        <span th:case="'RETURNED'" class="text-muted font-weight-bold">반품 완료</span>

                                        <!-- 주문 취소 -->
                                        <span th:case="'CANCELED'" class="text-muted font-weight-bold">주문 취소</span>
                                    </td>

                                    <!-- 상태 (비회원) -->
                                    <td th:if="${!isMember}" th:switch="${item.orderItemStatus.name()}">
                                        <span th:case="'PREPARING'" class="font-weight-bold">상품 준비중</span>
                                        <span th:case="'SHIPPED'" class="font-weight-bold">배송중</span>
                                        <div th:case="'DELIVERED'">
                                            <span class="d-block font-weight-bold mb-2">배송 완료</span>
                                            <form th:action="@{/orders/non-members/{orderId}/items/{itemId}/return(orderId=${order.orderId}, itemId=${item.orderItemId})}" method="post" class="return-form">
                                                <input type="hidden" name="reason" value="">
                                                <input type="hidden" name="password" th:value="${password}">
                                                <input type="hidden" name="orderNumber" th:value="${order.orderNumber}">
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                        반품하기
                                                    </button>
                                                    <div class="dropdown-menu">
                                                        <a class="dropdown-item return-reason-select" href="#" data-reason="CHANGE_OF_MIND">단순 변심</a>
                                                        <a class="dropdown-item return-reason-select" href="#" data-reason="DAMAGED">상품 파손</a>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                        <span th:case="'CONFIRMED'" class="font-weight-bold">구매 확정</span>
                                        <span th:case="'RETURN_REQUESTED_CHANGE_OF_MIND'" class="font-weight-bold">반품 요청 (단순 변심)</span>
                                        <span th:case="'RETURN_REQUESTED_DAMAGED'" class="font-weight-bold">반품 요청 (파손)</span>
                                        <span th:case="'RETURNED'" class="font-weight-bold">반품 완료</span>
                                        <span th:case="'CANCELED'" class="font-weight-bold">주문 취소</span>
                                    </td>

                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 결제 정보 -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="m-0">최종 결제 정보</h5>
                    </div>

                    <div class="card-body"
                         th:with="discount = ${(order.originPrice + order.deliveryFee) - order.totalPrice}">

                        <div class="border-bottom pt-3 pb-2">
                            <div class="d-flex justify-content-between mb-3">
                                <h6 class="text-dark">상품 금액</h6>
                                <h6 th:text="${#numbers.formatDecimal(order.originPrice,0,'COMMA',0,'POINT')} + '원'"></h6>
                            </div>

                            <div class="d-flex justify-content-between mb-3"
                                 th:if="${discount > 0}">
                                <h6 class="text-danger font-weight-medium">할인 금액</h6>
                                <h6 class="text-danger font-weight-medium"
                                    th:text="'-' + ${#numbers.formatDecimal(discount,0,'COMMA',0,'POINT')} + '원'"></h6>
                            </div>

                            <div class="d-flex justify-content-between">
                                <h6 class="font-weight-medium text-dark">배송비</h6>
                                <h6 th:text="${#numbers.formatDecimal(order.deliveryFee,0,'COMMA',0,'POINT')} + '원'"></h6>
                            </div>
                        </div>

                        <div class="pt-2">
                            <div class="d-flex justify-content-between mt-2">
                                <h5>총 결제 금액</h5>
                                <h5 th:text="${#numbers.formatDecimal(order.totalPrice,0,'COMMA',0,'POINT')} + '원'"></h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: 주문 정보 / 주문자 / 수령인 -->
            <div class="col-lg-4">

                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="m-0">주문 요약 정보</h5>
                    </div>

                    <div class="card-body">

                        <!-- 주문 정보 -->
                        <div class="mb-4">
                            <h6 class="mb-3">주문 정보</h6>
                            <table class="table table-bordered table-sm text-dark">
                                <tbody>
                                <tr>
                                    <th class="bg-light w-25">주문번호</th>
                                    <td th:text="${order.orderNumber}"></td>
                                </tr>

                                <tr>
                                    <th class="bg-light w-25">주문일시</th>
                                    <td th:text="${#temporals.format(order.orderDate, 'yyyy-MM-dd HH:mm')}"></td>
                                </tr>

                                <tr>
                                    <th class="bg-light w-25">주문상태</th>
                                    <td th:text="${order.orderStatus}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <hr>

                        <!-- 주문자 -->
                        <div class="mb-4">
                            <h6 class="mb-3">주문자 정보</h6>
                            <table class="table table-bordered table-sm text-dark">
                                <tbody>
                                <tr>
                                    <th class="bg-light w-25">이름</th>
                                    <td th:text="${order.ordererInfo.ordererName()}"></td>
                                </tr>

                                <tr>
                                    <th class="bg-light w-25">연락처</th>
                                    <td th:text="${order.ordererInfo.ordererContact()}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <hr>

                        <!-- 수령인 -->
                        <div>
                            <h6 class="mb-3">받는 사람 정보</h6>
                            <table class="table table-bordered table-sm text-dark">
                                <tbody>
                                <tr>
                                    <th class="bg-light w-25">이름</th>
                                    <td th:text="${order.receiverInfo.receiverName()}"></td>
                                </tr>

                                <tr>
                                    <th class="bg-light w-25">연락처</th>
                                    <td th:text="${order.receiverInfo.receiverContact()}"></td>
                                </tr>

                                <tr>
                                    <th class="bg-light w-25">주소</th>
                                    <td th:text="${order.receiverInfo().receiverAddress()}">
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>

                <!-- 주문 전체 취소 버튼 (회원) -->
                <div th:if="${isMember and order.orderItems != null
                             and !#lists.isEmpty(order.orderItems)
                             and #lists.size(order.orderItems.?[orderItemStatus.name() != 'PREPARING']) == 0}"
                     class="mb-3">
                    <form th:action="@{/orders/{orderId}/cancel(orderId=${order.orderId})}"
                          method="post"
                          onsubmit="return confirm('정말 주문 전체를 취소하시겠습니까?');">
                        <button type="submit" class="btn btn-danger btn-block py-3 font-weight-bold">
                            주문 전체 취소
                        </button>
                    </form>
                </div>

                <!-- 주문 전체 취소 버튼 (비회원) -->
                <div th:if="${!isMember and order.orderItems != null
                             and !#lists.isEmpty(order.orderItems)
                             and #lists.size(order.orderItems.?[orderItemStatus.name() != 'PREPARING']) == 0}"
                     class="mb-3">
                    <form th:action="@{/orders/non-members/{orderId}/cancel(orderId=${order.orderId})}"
                          method="post"
                          onsubmit="return confirm('정말 주문 전체를 취소하시겠습니까?');">
                        <input type="hidden" name="password" th:value="${password}">
                        <button type="submit" class="btn btn-danger btn-block py-3 font-weight-bold">
                            주문 전체 취소
                        </button>
                    </form>
                </div>

                <a th:href="${isMember} ? @{/api/members/my-page} : @{/orders/non-members-form}"
                   class="btn btn-primary btn-block py-3 font-weight-bold">목록으로</a>

            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="script">
    <script>
        $(document).ready(function() {
            $('.return-reason-select').on('click', function(e) {
                e.preventDefault(); // 링크의 기본 동작(페이지 이동)을 막습니다.

                // 클릭된 항목에서 data-reason 속성 값을 가져옵니다.
                var reason = $(this).data('reason');

                // 클릭된 항목에서 가장 가까운 .return-form 클래스를 가진 부모 폼을 찾습니다.
                var form = $(this).closest('.return-form');

                // 해당 폼 안에서 name이 'reason'인 input을 찾아 값을 설정합니다.
                form.find('input[name="reason"]').val(reason);

                // 사용자에게 확인을 요청하는 대화 상자를 띄웁니다.
                if (confirm('"' + $(this).text() + '" 사유로 반품을 진행하시겠습니까?')) {
                    // 사용자가 '확인'을 누르면 폼을 제출합니다.
                    form.submit();
                }
            });
        });
    </script>
</th:block>

</body>
</html>
