<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">

<head>
    <meta charset="utf-8">
    <title>Trillion-Shop | 주문 상세 정보</title>

    <th:block layout:fragment="head">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta content="주문, 상세, 내역" name="keywords">
        <meta content="온라인 도서 판매 사이트 주문 상세 정보" name="description">

        <style>
            .table-secondary {
                background-color: #f4f4f4;
            }
        </style>
    </th:block>
</head>

<body>

<div layout:fragment="content">

    <!-- Breadcrumb -->
    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-12">
                <nav class="breadcrumb bg-light mb-30">
                    <a class="breadcrumb-item text-dark" th:href="@{/}">홈</a>
                    <a class="breadcrumb-item text-dark" th:href="@{/api/members/my-page}">마이페이지</a>
                    <span class="breadcrumb-item active">주문 상세 정보</span>
                </nav>
            </div>
        </div>
    </div>

    <div class="container-fluid pb-5">
        <div class="row px-xl-5">

            <!-- Left: Items + Payment -->
            <div class="col-lg-8">

                <!-- 주문상품 목록 -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="m-0">주문 상품 목록</h5>
                    </div>

                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered text-center mb-0">
                                <thead class="bg-secondary text-dark">
                                <tr>
                                    <th>상품 정보</th>
                                    <th style="width: 15%;">단가</th>
                                    <th style="width: 10%;">수량</th>
                                    <th style="width: 15%;">포장비</th>
                                    <th style="width: 15%;">합계</th>
                                    <th style="width: 15%;">관리</th>
                                </tr>
                                </thead>

                                <tbody class="align-middle">
                                <tr th:each="item : ${order.orderItems}"
                                    th:classappend="${#lists.contains({'CANCELED','RETURNED'}, item.orderItemStatus.name())} ? 'table-secondary' : ''">

                                    <!-- 상품 정보 -->
                                    <td class="align-middle text-left">
                                        <div class="d-flex align-items-center">
                                            <img th:src="${item.thumbnailUrl != null ? item.thumbnailUrl : '/img/product-1.jpg'}"
                                                 alt="Book"
                                                 style="width: 50px; aspect-ratio: 1/1.4; object-fit: cover; margin-right: 15px;">
                                            <span th:text="${item.bookName}">책 제목</span>
                                        </div>
                                    </td>

                                    <!-- 단가 -->
                                    <td th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + '원'"></td>

                                    <!-- 수량 -->
                                    <td th:text="${item.quantity}"></td>

                                    <!-- 포장비 -->
                                    <td th:text="${item.packagingPrice > 0 ?
                                                  #numbers.formatDecimal(item.packagingPrice, 0, 'COMMA', 0, 'POINT') + '원'
                                                  : '-'}"></td>

                                    <!-- 합계 -->
                                    <td th:text="${#numbers.formatDecimal((item.price * item.quantity) + item.packagingPrice,
                                                0, 'COMMA', 0, 'POINT') + '원'}"></td>

                                    <!-- 상태별 버튼 -->
                                    <td>
                                        <!-- 취소 완료 -->
                                        <div th:if="${item.orderItemStatus.name() == 'CANCELED'}">
                                            <span class="text-muted font-weight-bold">취소 완료</span>
                                        </div>

                                        <!-- 반품 완료 -->
                                        <div th:if="${item.orderItemStatus.name() == 'RETURNED'}">
                                            <span class="text-muted font-weight-bold">반품 완료</span>
                                        </div>

                                        <!-- 배송 완료 -->
                                        <div th:if="${item.orderItemStatus.name() == 'DELIVERED'}">
                                            <form th:action="@{/orders/{orderId}/items/{itemId}/confirm(orderId=${order.orderId}, itemId=${item.orderItemId})}"
                                                  method="post" class="mb-1">
                                                <button type="submit" class="btn btn-sm btn-primary w-100">구매 확정</button>
                                            </form>

                                            <form th:action="@{/orders/{orderId}/items/{itemId}/return(orderId=${order.orderId}, itemId=${item.orderItemId})}"
                                                  method="post" class="mb-1">
                                                <input type="hidden" name="reason" value="CHANGE_OF_MIND">
                                                <button type="submit" class="btn btn-sm btn-outline-secondary w-100">단순 변심 반품</button>
                                            </form>

                                            <form th:action="@{/orders/{orderId}/items/{itemId}/return(orderId=${order.orderId}, itemId=${item.orderItemId})}"
                                                  method="post">
                                                <input type="hidden" name="reason" value="DAMAGED">
                                                <button type="submit" class="btn btn-sm btn-outline-danger w-100">상품 파손 반품</button>
                                            </form>
                                        </div>

                                        <!-- 구매 확정 -->
                                        <div th:if="${item.orderItemStatus.name() == 'CONFIRMED'}">
                                            <button class="btn btn-sm btn-success w-100">리뷰 작성</button>
                                        </div>

                                        <!-- 배송 중 -->
                                        <div th:if="${item.orderItemStatus.name() == 'SHIPPED'}">
                                            <button class="btn btn-sm btn-info w-100">배송 조회</button>
                                        </div>

                                        <!-- 반품 처리중 -->
                                        <div th:if="${#strings.startsWith(item.orderItemStatus.name(), 'RETURN_REQUESTED')}">
                                            <span class="text-muted">반품 처리중</span>
                                        </div>

                                        <!-- 나머지 (준비중 등) -->
                                        <div th:if="${!(#lists.contains({'CANCELED','RETURNED','DELIVERED','CONFIRMED','SHIPPED'}, item.orderItemStatus.name())
                                                        or #strings.startsWith(item.orderItemStatus.name(), 'RETURN_REQUESTED'))}">
                                            <span class="font-weight-bold" th:text="${item.orderItemStatus}"></span>
                                        </div>
                                    </td>

                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 결제 정보 -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="m-0">최종 결제 정보</h5>
                    </div>

                    <div class="card-body"
                         th:with="discount = (order.originPrice + order.deliveryFee) - order.totalPrice">

                        <div class="border-bottom pt-3 pb-2">
                            <div class="d-flex justify-content-between mb-3">
                                <h6 class="text-dark">상품 금액</h6>
                                <h6 th:text="${#numbers.formatDecimal(order.originPrice,0,'COMMA',0,'POINT')} + '원'"></h6>
                            </div>

                            <div class="d-flex justify-content-between mb-3"
                                 th:if="${discount > 0}">
                                <h6 class="text-danger font-weight-medium">할인 금액</h6>
                                <h6 class="text-danger font-weight-medium"
                                    th:text="'-' + ${#numbers.formatDecimal(discount,0,'COMMA',0,'POINT')} + '원'"></h6>
                            </div>

                            <div class="d-flex justify-content-between">
                                <h6 class="font-weight-medium text-dark">배송비</h6>
                                <h6 th:text="${#numbers.formatDecimal(order.deliveryFee,0,'COMMA',0,'POINT')} + '원'"></h6>
                            </div>
                        </div>

                        <div class="pt-2">
                            <div class="d-flex justify-content-between mt-2">
                                <h5>총 결제 금액</h5>
                                <h5 th:text="${#numbers.formatDecimal(order.totalPrice,0,'COMMA',0,'POINT')} + '원'"></h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: 주문 정보 / 주문자 / 수령인 -->
            <div class="col-lg-4">

                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="m-0">주문 요약 정보</h5>
                    </div>

                    <div class="card-body">

                        <!-- 주문 정보 -->
                        <div class="mb-4">
                            <h6 class="mb-3">주문 정보</h6>
                            <table class="table table-bordered table-sm text-dark">
                                <tbody>
                                <tr>
                                    <th class="bg-light w-25">주문번호</th>
                                    <td th:text="${order.orderNumber}"></td>
                                </tr>

                                <tr>
                                    <th class="bg-light w-25">주문일시</th>
                                    <td th:text="${#temporals.format(order.orderDate, 'yyyy-MM-dd HH:mm')}"></td>
                                </tr>

                                <tr>
                                    <th class="bg-light w-25">주문상태</th>
                                    <td th:text="${order.orderStatus}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <hr>

                        <!-- 주문자 -->
                        <div class="mb-4">
                            <h6 class="mb-3">주문자 정보</h6>
                            <table class="table table-bordered table-sm text-dark">
                                <tbody>
                                <tr>
                                    <th class="bg-light w-25">이름</th>
                                    <td th:text="${order.ordererInfo.name}"></td>
                                </tr>

                                <tr>
                                    <th class="bg-light w-25">연락처</th>
                                    <td th:text="${order.ordererInfo.phoneNumber}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <hr>

                        <!-- 수령인 -->
                        <div>
                            <h6 class="mb-3">받는 사람 정보</h6>
                            <table class="table table-bordered table-sm text-dark">
                                <tbody>
                                <tr>
                                    <th class="bg-light w-25">이름</th>
                                    <td th:text="${order.receiverInfo.name}"></td>
                                </tr>

                                <tr>
                                    <th class="bg-light w-25">연락처</th>
                                    <td th:text="${order.receiverInfo.phoneNumber}"></td>
                                </tr>

                                <tr>
                                    <th class="bg-light w-25">주소</th>
                                    <td th:text="${'(' + order.receiverInfo.zipcode + ') '
                                                   + order.receiverInfo.address + ' '
                                                   + order.receiverInfo.addressDetail}">
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>

                <!-- 주문 전체 취소 버튼 -->
                <div th:if="${order.orderItems != null
                             and !#lists.isEmpty(order.orderItems)
                             and #lists.size(order.orderItems.?[orderItemStatus.name() != 'PREPARING']) == 0}"
                     class="mb-3">
                    <form th:action="@{/orders/{orderId}/cancel(orderId=${order.orderId})}"
                          method="post"
                          onsubmit="return confirm('정말 주문 전체를 취소하시겠습니까?');">
                        <button type="submit" class="btn btn-danger btn-block py-3 font-weight-bold">
                            주문 전체 취소
                        </button>
                    </form>
                </div>

                <a th:href="@{/api/members/my-page}"
                   class="btn btn-primary btn-block py-3 font-weight-bold">목록으로</a>

            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="script">
    <!-- 필요 시 페이지별 스크립트 추가 가능 -->
</th:block>

</body>
</html>
