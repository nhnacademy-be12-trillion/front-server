<!--
  ~ /*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  ~ + Copyright 2025. NHN Academy Corp. All rights reserved.
  ~ + * While every precaution has been taken in the preparation of this resource,  assumes no
  ~ + responsibility for errors or omissions, or for damages resulting from the use of the information
  ~ + contained herein
  ~ + No part of this resource may be reproduced, stored in a retrieval system, or transmitted, in any
  ~ + form or by any means, electronic, mechanical, photocopying, recording, or otherwise, without the
  ~ + prior written permission.
  ~ +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/
  -->

<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">

<head>
    <meta charset="UTF-8">
    <title>Trillion-Shop | 도서 목록</title>

    <th:block layout:fragment="head">
        <!-- 페이지 전용 head 요소 (필요 시 추가) -->
    </th:block>
    <style>
        /* 공통 썸네일 크기 고정 (그리드 카드용) */
        .book-thumb {
            display: block;
            width: 100%;
            height: 240px;          /* 여기 숫자로 전체 크기 조절 */
            object-fit: cover;
            background: #f3f3f3;    /* 로딩 중/깨짐 시 회색 배경 */
        }

        /* 기존 레이아웃이 aspect-ratio를 쓰고 있으면 높이를 여기서 통일하는 게 더 안정적 */
        .product-img .book-thumb,
        .book-card .book-thumb {
            height: 240px;
        }

    </style>
</head>

<body>
<div layout:fragment="content">

    <div class="container-fluid">
        <div class="row px-xl-5">

            <!-- ====== 왼쪽 카테고리(옵션) ====== -->
            <div class="col-lg-3 col-md-4">
                <h5 class="section-title position-relative text-uppercase mb-3">
                    <span class="bg-secondary pr-3">도서 메뉴</span>
                </h5>

                <div class="nav flex-column nav-pills book-menu" role="tablist">
                    <a class="nav-link active" data-toggle="pill" href="#tab-all">전체 도서</a>
                    <a class="nav-link" href="#" th:href="@{/api/books?sort=best}">베스트</a>
                    <a class="nav-link" href="#" th:href="@{/api/books?sort=new}">최근 발매</a>
                    <a class="nav-link" href="#" th:href="@{/api/books/birthday}">생일책</a>
                </div>
            </div>

            <!-- ====== 오른쪽 리스트 영역 ====== -->
            <div class="col-lg-9 col-md-8">

                <h5 class="section-title position-relative text-uppercase mb-3">
                    <span class="bg-secondary pr-3">도서 목록</span>
                </h5>

                <div class="row">

                    <!-- ====== books 리스트 렌더링 ====== -->
                    <div class="col-lg-3 col-md-4 col-sm-6 pb-1"
                         th:each="book : ${books}">

                        <div class="book-card">

                            <!-- 썸네일: 없으면 fallback 이미지 -->
                            <img class="img-fluid w-100 book-thumb"
                                 th:src="${!#strings.isEmpty(book.bookImage) ? book.bookImage : '/img/default-book.png'}"
                                 th:attr="onerror=|this.onerror=null;this.src='/img/default-book.png';|"
                                 alt="이미지가 준비중입니다."
                                 loading="lazy">

                            <!-- 도서명 -->
                            <div class="book-card-title"
                                 th:text="${book.bookName != null ? book.bookName : '제목 정보 없음'}">
                                책 제목
                            </div>

                            <!-- 저자 -->
                            <div class="book-card-author"
                                 th:text="${book.bookAuthor != null ? book.bookAuthor : '저자 정보 없음'}">
                                저자명
                            </div>

                            <!-- 출판사 (null 방어) -->
                            <div class="book-card-author small text-muted"
                                 th:text="${book.bookPublisher != null ? book.bookPublisher : '출판사 정보 없음'}">
                                출판사명
                            </div>

                            <!-- 도서 상태 -->
                            <div class="mt-1">
                                <span class="badge badge-info"
                                      th:if="${book.bookState != null}"
                                      th:text="${book.bookState}">
                                    NEW
                                </span>
                                <span class="badge badge-secondary" th:if="${book.bookState == null}">
                                    상태 미표기
                                </span>
                            </div>

                            <!-- 가격 -->
                            <div class="book-card-price mt-2">

                                <!-- 세일가: 없으면 정상가만 -->
                                <div th:if="${book.bookSalePrice > 0}">
                                    <span class="text-primary font-weight-bold"
                                          th:text="${#numbers.formatInteger(book.bookSalePrice, 0, 'COMMA')} + '원'">
                                        12,000원
                                    </span>

                                    <span class="text-muted ml-1">
                                        <del th:text="${#numbers.formatInteger(book.bookRegularPrice, 0, 'COMMA')} + '원'">
                                            15,000원
                                        </del>
                                    </span>

                                    <span class="ml-1 badge badge-danger"
                                          th:text="${book.discountRate + '%'}">
                                        20%
                                    </span>
                                </div>

                                <!-- 할인 없는 경우 -->
                                <div th:if="${book.bookSalePrice == 0}">
                                    <span class="text-primary font-weight-bold"
                                          th:text="${#numbers.formatInteger(book.bookRegularPrice, 0, 'COMMA')} + '원'">
                                        15,000원
                                    </span>
                                </div>

                            </div>

                            <!-- 버튼 영역 -->
                            <div class="mt-3 d-flex justify-content-between">
                                <!-- 좋아요 -->
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                        th:onclick="'location.href=\'/api/books/' + ${book.bookId} + '/like\''">
                                    <i class="fas fa-heart"></i>
                                </button>

                                <!-- 장바구니 -->
                                <button type="button"
                                        class="btn btn-sm btn-outline-dark btn-add-cart"
                                        th:data-book-id="${book.bookId}"
                                        data-quantity="1">
                                    장바구니
                                </button>

                            </div>

                        </div>

                    </div>


                    <!-- ====== books 리스트가 비었을 때 ====== -->
                    <div class="col-12"
                         th:if="${books == null or #lists.isEmpty(books)}">
                        <div class="bg-light text-center py-5">
                            <h5 class="text-muted mb-2">검색 결과가 없습니다.</h5>
                            <a th:href="@{/api/books}" class="btn btn-primary btn-sm">전체 도서 보기</a>
                        </div>
                    </div>

                </div>

            </div>

        </div>
    </div>

</div>

<th:block layout:fragment="script">
    <script>
        $(function () {
            $('.btn-add-cart').on('click', function () {
                const bookId = $(this).data('book-id');
                // 수량 input 이 따로 있으면 거기서 읽어오는 것도 가능
                let quantity = $(this).data('quantity') || 1;

                $.ajax({
                    url: '/carts',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        bookId: bookId,
                        cartQuantity: quantity
                    }),
                    success: function (res) {
                        // res.success, res.message 사용 가능
                        alert(res.message || '장바구니에 담았습니다.');

                        // TODO: 카트 배지도 업데이트하고 싶으면 여기서 처리
                        // $('#cart-count').text(res.cartCount);
                    },
                    error: function (xhr) {
                        if (xhr.status === 401) {
                            alert('로그인이 필요합니다.');
                            // location.href = '/login';  // 필요하면 로그인 페이지로 이동
                        } else {
                            alert('장바구니 담기 중 오류가 발생했습니다.');
                        }
                    }
                });
            });
        });
    </script>

</th:block>

</body>
</html>
