<!--
  ~ /*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  ~ + Copyright 2025. NHN Academy Corp. All rights reserved.
  ~ + * While every precaution has been taken in the preparation of this resource,  assumes no
  ~ + responsibility for errors or omissions, or for damages resulting from the use of the information
  ~ + contained herein
  ~ + No part of this resource may be reproduced, stored in a retrieval system, or transmitted, in any
  ~ + form or by any means, electronic, mechanical, photocopying, recording, or otherwise, without the
  ~ + prior written permission.
  ~ +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/
  -->

<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/base}">

<head>
  <meta charset="utf-8">
  <title>Trillion-Shop | My Page</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="Book Store, MyPage, Member" name="keywords">
  <meta content="Online Book Store My Page" name="description">

  <link th:href="@{/img/favicon.ico}" rel="icon">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <link th:href="@{/lib/animate/animate.min.css}" rel="stylesheet">
  <link th:href="@{/lib/owlcarousel/assets/owl.carousel.min.css}" rel="stylesheet">
  <link href="/css/style.min.css" rel="stylesheet">

  <style>
    /* 반품(노랑) 버튼 */
    .btn-return {
      color: #b88600 !important;
      border: 1px solid #e0b200 !important;
      background-color: #fffbea !important;
    }

    .btn-return:hover {
      background-color: #ffe08a !important;
      border-color: #d4a300 !important;
    }

    /* 파손(빨강) 버튼 */
    .btn-damage {
      color: #b00020 !important;
      border: 1px solid #d32f2f !important;
      background-color: #fff5f5 !important;
    }

    .btn-damage:hover {
      background-color: #ffcccc !important;
      border-color: #c62828 !important;
    }
    .mypage-menu .list-group-item {
      margin-top: 10px;
      margin-bottom: 8px;   /* 탭 버튼 간 간격 */
      border-radius: 6px;   /* 버튼 둥글림 옵션 (선택) */
    }

    .mypage-menu .list-group-item.active {
      margin-bottom: 8px;
    }

  </style>
</head>

<body>
<!-- 상단 바 / 헤더 -->
<div class="container-fluid">
  <!-- 상단 회색 바 -->
  <div class="row bg-secondary py-1 px-xl-5">
    <div class="col-lg-6 d-none d-lg-block">
      <div class="d-inline-flex align-items-center h-100">
        <a class="text-body mr-3" href="">About</a>
        <a class="text-body mr-3" href="">Contact</a>
        <a class="text-body mr-3" href="">Help</a>
        <a class="text-body mr-3" href="">FAQs</a>
      </div>
    </div>
    <div class="col-lg-6 text-center text-lg-right">
      <!-- 데스크톱: 환영 문구 -->
      <div class="d-inline-flex align-items-center d-none d-lg-inline-flex">
        <span class="text-body small"
              th:text="${member.name} + ' 님, 마이페이지에 오신 것을 환영합니다.'">
          홍길동 님, 마이페이지에 오신 것을 환영합니다.
        </span>
      </div>

      <!-- 모바일: 좋아요 / 장바구니 아이콘 -->
      <div class="d-inline-flex align-items-center d-block d-lg-none">
        <a th:href="@{/api/members/likes}" class="btn px-0 ml-2">
          <i class="fas fa-heart text-dark"></i>
          <span class="badge text-dark border border-dark rounded-circle"
                style="padding-bottom: 2px;">0</span>
        </a>
        <a th:href="@{/api/carts}" class="btn px-0 ml-2">
          <i class="fas fa-shopping-cart text-dark"></i>
          <span class="badge text-dark border border-dark rounded-circle"
                style="padding-bottom: 2px;">0</span>
        </a>
      </div>
    </div>
  </div>

  <!-- 로고 / 검색 / 마이페이지 영역 -->
  <div class="row align-items-center bg-light py-3 px-xl-5 d-none d-lg-flex">
    <div class="col-lg-4">
      <a th:href="@{/}" class="text-decoration-none">
        <img src="/static/img/logo.png" alt="Book E-commerce Logo"
             class="img-fluid" style="background-color: #fff;">
      </a>
    </div>

    <div class="col-lg-4 col-6 text-left">
      <form th:action="@{/api/books/search}" method="get">
        <div class="input-group">
          <input type="text" name="keyword" class="form-control"
                 placeholder="Search for books">
          <div class="input-group-append">
            <button type="submit" class="input-group-text bg-transparent text-primary">
              <i class="fa fa-search"></i>
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- 로그인 전제: 환영 문구 + 마이페이지 / 로그아웃 -->
    <div class="col-lg-4 col-6 text-right">
      <div class="d-inline-flex flex-column align-items-end w-100">
        <span class="small mb-2"
              th:text="${member.name} + ' 님, 환영합니다'">
          홍길동 님, 환영합니다
        </span>
        <div>
          <a th:href="@{/api/members/my-page}" class="btn btn-sm btn-primary mx-1">
            마이페이지
          </a>
          <a th:href="@{/api/auth/logout}" class="btn btn-sm btn-outline-secondary mx-1 text-dark">
            로그아웃
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 상단 네비게이션 -->
<div class="container-fluid bg-dark mb-30">
  <div class="row px-xl-5">
    <div class="col-lg-3 d-none d-lg-block">
      <a class="btn d-flex align-items-center justify-content-between bg-primary w-100"
         data-toggle="collapse" href="#navbar-vertical"
         style="height: 65px; padding: 0 30px;">
        <h6 class="text-dark m-0"><i class="fa fa-bars mr-2"></i>Categories</h6>
        <i class="fa fa-angle-down text-dark"></i>
      </a>
      <nav class="collapse position-absolute navbar navbar-vertical navbar-light align-items-start p-0 bg-light"
           id="navbar-vertical"
           style="width: calc(100% - 30px); z-index: 999;">
        <div class="navbar-nav w-100">
          <th:block th:if="${categories != null and !categories.empty}">
            <a th:each="cat : ${categories}"
               th:href="@{/api/books/category/{id}(id=${cat.id})}"
               class="nav-item nav-link" th:text="${cat.name}">
              Category Name
            </a>
          </th:block>
          <th:block th:unless="${categories != null and !categories.empty}">
            <a href="#" class="nav-item nav-link">국내도서</a>
            <a href="#" class="nav-item nav-link">외국도서</a>
            <a href="#" class="nav-item nav-link">E-Book</a>
          </th:block>
        </div>
      </nav>
    </div>

    <div class="col-lg-9">
      <nav class="navbar navbar-expand-lg bg-dark navbar-dark py-3 py-lg-0 px-0">
        <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
          <div class="navbar-nav mr-auto py-0">
            <a th:href="@{/}" class="nav-item nav-link">Home</a>
            <a th:href="@{/api/books}" class="nav-item nav-link">Shop</a>
            <a th:href="@{/api/carts}" class="nav-item nav-link">Cart</a>
          </div>
          <div class="navbar-nav ml-auto py-0 d-none d-lg-block">
            <a th:href="@{/api/members/likes}" class="btn px-0">
              <i class="fas fa-heart text-primary"></i>
              <span class="badge text-secondary border border-secondary rounded-circle"
                    style="padding-bottom: 2px;">0</span>
            </a>
            <a th:href="@{/api/carts}" class="btn px-0 ml-3">
              <i class="fas fa-shopping-cart text-primary"></i>
              <span class="badge text-secondary border border-secondary rounded-circle"
                    style="padding-bottom: 2px;">0</span>
            </a>
          </div>
        </div>
      </nav>
    </div>
  </div>
</div>

<!-- 메인 컨텐츠: MY PAGE -->
<div class="container-fluid">
  <div class="row px-xl-5">

    <!-- 왼쪽 MY 메뉴 -->
    <div class="col-lg-3 col-md-4">
      <h5 class="section-title position-relative text-uppercase mb-3">
        <span class="bg-secondary pr-3">MY 메뉴</span>
      </h5>

      <!-- 주문 내역 -->
      <div class="mb-4">
        <h6 class="text-dark mb-2">📦 주문 내역</h6>
        <div class="list-group mypage-menu">
          <a th:href="@{/api/members/my-page(tab='orders')}"
             class="list-group-item list-group-item-action"
             th:classappend="${activeTab} == null || ${activeTab} == 'orders' ? ' active' : ''">
            주문 조회/변경/취소
          </a>
          <a th:href="@{/api/orders/returns}"
             class="list-group-item list-group-item-action">
            반품/교환 내역
          </a>
        </div>
      </div>

      <hr class="my-4">

      <!-- 회원 정보 관리 -->
      <div class="mb-4">
        <h6 class="text-dark mb-2">👤 회원 정보 관리</h6>
        <div class="list-group mypage-menu">
          <a th:href="@{/api/members/my-page(tab='profile')}"
             class="list-group-item list-group-item-action"
             th:classappend="${activeTab} == 'profile' ? ' active' : ''">
            개인정보 수정
          </a>
          <a th:href="@{/api/members/my-page(tab='reviews')}"
             class="list-group-item list-group-item-action"
             th:classappend="${activeTab} == 'reviews' ? ' active' : ''">
            마이 리뷰 조회/관리
          </a>
          <a th:href="@{/api/members/my-page(tab='addresses')}"
             class="list-group-item list-group-item-action"
             th:classappend="${activeTab} == 'addresses' ? ' active' : ''">
            배송 주소록 관리
          </a>
        </div>
      </div>

      <!-- 회원 탈퇴 -->
      <div class="list-group mypage-menu mb-4">
        <a th:href="@{/api/auth/withdraw}"
           class="list-group-item list-group-item-action text-danger">
          회원 탈퇴
        </a>
      </div>
    </div>

    <!-- 오른쪽: 탭별 내용 -->
    <div class="col-lg-9 col-md-8">

      <!-- 1) 주문 조회/변경/취소 탭 (기본) -->
      <div th:if="${activeTab} == null or ${activeTab} == 'orders'">
        <h5 class="section-title position-relative text-uppercase mb-3">
          <span class="bg-secondary pr-3">주문 조회/변경/취소</span>
        </h5>

        <div class="bg-light p-4">
          <div class="table-responsive">
            <table class="table table-bordered mb-0 text-center">
              <thead class="bg-secondary text-dark">
              <tr>
                <th style="width:10%;">주문일</th>
                <th style="width:15%;">주문번호</th>
                <th style="width:10%;">수령인</th>
                <th style="width:35%;">주문상품</th>
                <th style="width:10%;">배송상태</th>
                <th style="width:20%;">관리</th>
              </tr>
              </thead>

              <!-- 주문 내역 있을 때 -->
              <tbody th:if="${orders != null and !#lists.isEmpty(orders)}">
              <tr th:each="order : ${orders}">
                <!-- 주문일 -->
                <td class="align-middle">
                  <span th:text="${#temporals.format(order.orderDate, 'yyyy-MM-dd')}">
                    2000-00-00
                  </span>
                </td>

                <!-- 주문번호 -->
                <td class="align-middle">
                  <a class="text-primary font-weight-bold"
                     th:href="@{/api/members/{orderId}(orderId=${order.id})}"
                     th:text="${order.orderNumber}">
                    001-A123456789
                  </a>
                </td>

                <!-- 수령인 -->
                <td class="align-middle">
                  <span th:text="${order.receiverName}">홍길동</span>
                </td>

                <!-- 주문상품 -->
                <td class="align-middle text-left">
                  <div class="font-weight-bold text-truncate"
                       th:text="${order.mainBookTitle}">
                    [도서] 외의 쓸모
                  </div>
                  <div class="small text-muted">
                    총
                    <span th:text="${order.totalQuantity}">1</span>권,
                    <span th:text="${#numbers.formatInteger(order.totalPrice, 0, 'COMMA')}">15,400</span>원
                  </div>
                </td>

                <!-- 배송상태 -->
                <td class="align-middle">
                  <span class="text-dark font-weight-bold"
                        th:text="${order.status}">배송중</span>
                </td>

                <!-- 관리 버튼들 -->
                <td class="align-middle">
                  <div class="d-flex flex-column align-items-stretch">
                    <button type="button" class="btn btn-sm btn-outline-dark mb-1">
                      주문확인
                    </button>
                    <button type="button" class="btn btn-sm btn-return mb-1">
                      반품
                    </button>
                    <button type="button" class="btn btn-sm btn-damage mb-1">
                      파손
                    </button>
                    <button type="button" class="btn btn-sm btn-primary">
                      구매확정
                    </button>
                  </div>
                </td>
              </tr>
              </tbody>

              <!-- 주문 내역 없을 때 -->
              <tbody th:if="${orders == null or #lists.isEmpty(orders)}">
              <tr>
                <td colspan="6" class="py-5 text-muted">
                  조회 가능한 주문 내역이 없습니다.
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 2) 개인정보 수정 탭 -->
      <div th:if="${activeTab} == 'profile'">
        <h5 class="section-title position-relative text-uppercase mb-3">
          <span class="bg-secondary pr-3">개인정보 수정</span>
        </h5>

        <div class="bg-light p-5">
          <form th:action="@{/api/members/info}" method="post" th:object="${member}">
            <div class="form-group">
              <label>이름</label>
              <input class="form-control" type="text"
                     th:field="*{name}" placeholder="이름을 입력하세요">
            </div>

            <div class="form-group">
              <label>이메일</label>
              <input class="form-control" type="email"
                     th:value="*{email}" readonly>
            </div>

            <div class="form-group">
              <label>비밀번호</label>
              <div class="d-flex">
                <input class="form-control mr-5" type="text"
                       value="********" readonly>
                <a th:href="@{/api/members/password}"
                   class="btn btn-sm btn-outline-secondary text-dark mr-2 text-sm-center">
                  비밀번호 변경
                </a>
              </div>
            </div>

            <div class="form-group">
              <label>연락처</label>
              <input class="form-control" type="text"
                     th:field="*{phoneNumber}" placeholder="010-0000-0000">
            </div>

            <div class="form-group">
              <label>생일</label>
              <input class="form-control" type="date"
                     th:field="*{birthday}"
                     th:value="${member.birthday != null ? #temporals.format(member.birthday, 'yyyy-MM-dd') : ''}">
              <small class="form-text text-muted">
                생일 정보를 기준으로 생일 쿠폰 등 맞춤 서비스를 제공할 수 있습니다.
              </small>
            </div>

            <div class="text-right mt-4">
              <button type="submit" class="btn btn-primary px-4">
                수정하기
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- 3) 마이 리뷰 조회/관리 탭 -->
      <div th:if="${activeTab} == 'reviews'">
        <h5 class="section-title position-relative text-uppercase mb-3">
          <span class="bg-secondary pr-3">마이 리뷰 조회/관리</span>
        </h5>

        <div class="bg-light p-4">
          <div class="table-responsive">
            <table class="table table-bordered mb-0 text-center">
              <thead style="background-color:#f3fcff;">
              <tr>
                <th style="width:15%;">주문번호</th>
                <th style="width:15%;">작성일자</th>
                <th style="width:20%;">상품</th>
                <th style="width:35%;">내용</th>
                <th style="width:15%;">상태</th>
              </tr>
              </thead>

              <!-- 리뷰 있을 때 -->
              <tbody th:if="${reviews != null and !#lists.isEmpty(reviews)}">
              <tr th:each="review : ${reviews}">
                <td class="align-middle">
                  <a th:href="@{/api/members/{orderId}(orderId=${review.orderId})}"
                     class="text-primary"
                     th:text="${review.orderNumber}">
                    001-A123456789
                  </a>
                </td>
                <td class="align-middle">
                  <span th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd')}">
                    2025-10-18
                  </span>
                </td>
                <td class="align-middle text-left">
                  <a th:href="@{/api/books/{id}(id=${review.bookId})}"
                     class="text-dark"
                     th:text="${review.bookTitle}">
                    [도서] 책 제목
                  </a>
                </td>
                <td class="align-middle text-left">
                  <span class="d-inline-block text-truncate"
                        style="max-width: 100%;"
                        th:text="${review.content}">
                    리뷰 내용이 한 줄 정도로 표시됩니다.
                  </span>
                </td>
                <td class="align-middle">
                  <span th:text="${review.status}">노출중</span>
                </td>
              </tr>
              </tbody>

              <!-- 리뷰 없을 때 -->
              <tbody th:if="${reviews == null or #lists.isEmpty(reviews)}">
              <tr>
                <td colspan="5" class="py-5 text-muted">
                  작성한 리뷰가 없습니다.
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 4) 배송 주소록 관리 탭 -->
      <div th:if="${activeTab} == 'addresses'">
        <h5 class="section-title position-relative text-uppercase mb-3">
          <span class="bg-secondary pr-3">배송 주소록 관리</span>
        </h5>

        <div class="bg-light p-4">
          <!-- 검색 & 버튼 -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <!-- 왼쪽: 수령인 검색 -->
            <form th:action="@{/api/members/addresses}" method="get"
                  class="form-inline flex-grow-1">
              <div class="input-group w-100" style="max-width: 400px;">
                <input type="text" name="receiverName" class="form-control"
                       placeholder="'수령인'을 입력해주세요.">
                <div class="input-group-append">
                  <button type="submit" class="btn btn-primary">
                    주소검색
                  </button>
                </div>
              </div>
            </form>

            <!-- 오른쪽: 선택삭제 / 새 주소 추가 -->
            <div class="ml-3 text-right">
              <button type="submit" form="addressDeleteForm"
                      class="btn btn-sm btn-outline-secondary mr-2">
                선택삭제
              </button>
              <a th:href="@{/api/members/addresses/new}"
                 class="btn btn-sm btn-primary">
                + 새 주소 추가
              </a>
            </div>
          </div>

          <!-- 주소 목록 -->
          <form th:action="@{/api/members/addresses/delete}" method="post"
                id="addressDeleteForm">
            <div class="table-responsive">
              <table class="table table-bordered mb-0">
                <thead style="background-color:#f3fcff;">
                <tr class="text-center">
                  <th style="width:5%;">
                    <input type="checkbox" id="checkAll">
                  </th>
                  <th style="width:20%;">수령인</th>
                  <th>주소</th>
                  <th style="width:12%;">수정/삭제</th>
                </tr>
                </thead>

                <!-- 주소 있을 때 -->
                <tbody th:if="${addresses != null and !#lists.isEmpty(addresses)}">
                <tr th:each="addr : ${addresses}">
                  <td class="align-middle text-center">
                    <input type="checkbox" name="addressIds"
                           th:value="${addr.id}" class="address-check">
                  </td>
                  <td class="align-middle">
                    <div class="font-weight-bold"
                         th:text="${addr.receiverName}">
                      홍길동
                    </div>
                    <div class="small text-danger"
                         th:if="${addr.defaultAddress}">
                      (기본 정보 주소)
                    </div>
                  </td>
                  <td class="align-middle">
                    <div th:text="'(' + ${addr.zipcode} + ')'">
                      11111
                    </div>
                    <div th:text="${addr.addressLine}">
                      광역시
                    </div>
                    <div th:text="${addr.phoneNumber}">
                      010-0000-0000
                    </div>
                  </td>
                  <td class="align-middle text-center">
                    <a th:href="@{/api/members/addresses/{id}/edit(id=${addr.id})}"
                       class="btn btn-sm btn-outline-secondary">
                      수정
                    </a>
                  </td>
                </tr>
                </tbody>

                <!-- 주소 없을 때 -->
                <tbody th:if="${addresses == null or #lists.isEmpty(addresses)}">
                <tr>
                  <td colspan="4" class="py-4 text-center text-muted">
                    등록된 배송지가 없습니다. ‘+ 새 주소 추가’ 버튼을 눌러 배송지를 등록해 주세요.
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </form>
        </div>
      </div>

    </div><!-- /col-lg-9 -->
  </div><!-- /row -->
</div><!-- /container-fluid -->

<!-- footer fragment 자리 -->
<th:block layout:fragment="script">
</th:block>

<a href="#" class="btn btn-primary back-to-top">
  <i class="fa fa-angle-double-up"></i>
</a>

<script th:src="@{/js/main.js}"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/lib/easing/easing.min.js}"></script>
<script th:src="@{/lib/owlcarousel/owl.carousel.min.js}"></script>

<script>
  // 배송 주소록 전체 선택
  $(function () {
    $('#checkAll').on('change', function () {
      $('.address-check').prop('checked', $(this).prop('checked'));
    });
  });
</script>
</body>
</html>
