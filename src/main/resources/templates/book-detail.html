<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">

<head>
    <meta charset="utf-8">
    <title>Trillion-Shop | 도서 상세</title>

    <th:block layout:fragment="head">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta content="Book Store, Book Detail" name="keywords">
        <meta content="Online Book Store Book Detail" name="description">
    </th:block>
</head>

<body>
<div layout:fragment="content">

    <div class="container-fluid pt-5">
        <div class="row px-xl-5">

            <!-- (선택) 왼쪽 카테고리 -->
            <div class="col-lg-3 col-md-4" th:if="${categories != null and !#lists.isEmpty(categories)}">
                <h5 class="section-title position-relative text-uppercase mb-4">
                    <span class="bg-secondary pr-3">카테고리</span>
                </h5>
                <div class="bg-light p-3 mb-4">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2" th:each="depth1 : ${categories}">
                            <strong th:text="${depth1.name}">대분류</strong>
                            <ul class="list-unstyled ml-3 mt-2"
                                th:if="${depth1.children != null and !#lists.isEmpty(depth1.children)}">
                                <li class="mb-1" th:each="depth2 : ${depth1.children}">
                                    <span th:text="${depth2.name}">중분류</span>
                                    <ul class="list-unstyled ml-3 mt-1"
                                        th:if="${depth2.children != null and !#lists.isEmpty(depth2.children)}">
                                        <li th:each="depth3 : ${depth2.children}">
                                            <a th:href="@{/books/category/{id}(id=${depth3.id})}"
                                               class="text-body d-block"
                                               th:text="${depth3.name}">
                                                소분류
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 상세 본문 -->
            <div th:class="${categories != null and !#lists.isEmpty(categories)} ? 'col-lg-9 col-md-8' : 'col-12'">

                <div class="bg-light p-4 mb-4" th:if="${book != null}">
                    <div class="row">

                        <!-- 표지 -->
                        <div class="col-md-4 text-center mb-4 mb-md-0">
                            <img class="img-fluid"
                                 th:src="${book.bookImage != null ? book.bookImage : '/img/default-book.png'}"
                                 alt="책 표지"
                                 style="max-width: 100%; aspect-ratio: 1/1.4; object-fit: cover;">
                        </div>

                        <!-- 정보 -->
                        <div class="col-md-8">
                            <h3 class="mb-2" th:text="${book.bookName}">도서 제목</h3>

                            <p class="mb-1 text-muted">
                                <strong>저자</strong> <span th:text="${book.bookAuthor}">저자명</span>
                            </p>
                            <p class="mb-1 text-muted">
                                <strong>출판사</strong> <span th:text="${book.bookPublisher}">출판사명</span>
                            </p>

                            <div class="d-flex align-items-center mt-3">
                                <h4 class="mb-0 mr-3"
                                    th:text="${#numbers.formatInteger(book.bookSalePrice, 0, 'COMMA')} + '원'">
                                    12,000원
                                </h4>
                                <small class="text-muted" th:if="${book.bookRegularPrice > book.bookSalePrice}">
                                    <del th:text="${#numbers.formatInteger(book.bookRegularPrice, 0, 'COMMA')} + '원'">15,000원</del>
                                </small>
                            </div>

                            <p class="mt-2 mb-4">
                                <small class="text-muted">
                                    할인율 <span th:text="${book.discountRate}">0</span>%
                                    · 평점 <span th:text="${book.bookReviewRate}">0.0</span>
                                </small>
                            </p>

                            <!-- 수량 + 장바구니 -->
                            <div class="d-flex align-items-center mb-3">
                                <div class="input-group mr-3" style="width: 140px;">
                                    <div class="input-group-prepend">
                                        <button type="button" class="btn btn-primary" id="qtyMinus">
                                            <i class="fa fa-minus"></i>
                                        </button>
                                    </div>
                                    <input type="text" class="form-control text-center bg-secondary border-0"
                                           id="qtyInput" value="1" readonly>
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-primary" id="qtyPlus">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                    </div>
                                </div>

                                <form th:action="@{/carts}" method="post" class="mr-2">
                                    <input type="hidden" name="bookId" th:value="${book.bookId}">
                                    <input type="hidden" name="cartQuantity" id="cartQuantityHidden" value="1">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fa fa-shopping-cart mr-1"></i> 장바구니 담기
                                    </button>
                                </form>

                                <form th:action="@{/members/likes}" method="post">
                                    <input type="hidden" name="bookId" th:value="${book.bookId}">
                                    <button type="submit" class="btn btn-outline-dark">
                                        <i class="fa fa-heart mr-1"></i> 좋아요
                                    </button>
                                </form>
                            </div>

                            <a class="btn btn-sm btn-light" th:href="@{/books}">
                                목록으로
                            </a>
                        </div>
                    </div>
                </div>

                <!-- book이 없을 때 -->
                <div class="bg-light p-5 text-center" th:if="${book == null}">
                    <h4>도서 정보를 찾을 수 없습니다.</h4>
                    <a class="btn btn-primary mt-3" th:href="@{/books}">목록으로</a>
                </div>

            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="script">
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const minus = document.getElementById('qtyMinus');
            const plus = document.getElementById('qtyPlus');
            const input = document.getElementById('qtyInput');
            const hidden = document.getElementById('cartQuantityHidden');

            if (!minus || !plus || !input || !hidden) return;

            function syncHidden() {
                hidden.value = input.value;
            }

            minus.addEventListener('click', function () {
                const v = Math.max(1, parseInt(input.value || '1', 10) - 1);
                input.value = String(v);
                syncHidden();
            });

            plus.addEventListener('click', function () {
                const v = parseInt(input.value || '1', 10) + 1;
                input.value = String(v);
                syncHidden();
            });
        });
    </script>
</th:block>

</body>
</html>
